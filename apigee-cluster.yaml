# Copyright 2020 Google Inc. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

imports:
- path: apigee-cluster.jinja
- path: apigee-enable-services.jinja
- path: apigee-service-accounts.jinja
- path: apigee-overrides.jinja
- path: config/ingress-server.key
  name: ingress-server.key
- path: config/ingress-server.pem
  name: ingress-server.pem
- path: config/mart-server.key
  name: mart-server.key
- path: config/mart-server.pem
  name: mart-server.pem

resources:
# This causes issues in cleanup. 
#- name: apigee-enable-services
#  type: apigee-enable-services.jinja
- name: apigee-service-accounts
  type: apigee-service-accounts.jinja
  properties:
    uniqueId : {{uniqueId}}
- name: apigee-cluster
  type: apigee-cluster.jinja
  metadata:
      dependsOn:
         - apigee-service-accounts
  properties:
    # GCP project and cluster
    k8s_cluster:
      name: apigee-hybrid
      location: us-east1
      zone: us-east1-b
      initialNodeCount: 3
      instanceType: n1-standard-4
      diskSizeGb: 30
      autoscaling: false
      autoUpgrade: false
      autoRepair: false
      imageType: COS
    apigee:
      gcpProjectID: {{org}}
      # Kubernetes cluster name.
      k8sClusterName: apigee-hybrid
        # Apigee org name.
      org: {{org}}
      envs:
            # Apigee environment name.
        - name: test
            # Domain name to which api traffic is sent.
          hostAlias: "{{org}}-test.hybrid-apigee.net"
            # Certificate for the domain name; this can be self signed.
          sslCertPath: ingress-server.pem
            # Private key for the domain name; this can be self signed.
          sslKeyPath: ingress-server.key
            # Service accounts for sync and UDCA.
          serviceAccountPaths:
            synchronizer: ./service-accounts/{{org}}-synchronizer-apigee.json
            udca: ./service-accounts/{{org}}-udca-apigee.json
        - name: prod
            # Domain name to which api traffic is sent.
          hostAlias: "{{org}}-prod.hybrid-apigee.net"
            # Certificate for the domain name; this can be self signed.
          sslCertPath: ingress-server.pem
            # Private key for the domain name; this can be self signed.
          sslKeyPath: ingress-server.key
            # Service accounts for sync and UDCA.
          serviceAccountPaths:
            synchronizer: ./service-accounts/{{org}}-synchronizer-apigee.json
            udca: ./service-accounts/{{org}}-udca-apigee.json
      mart:
        hostAlias: "{{org}}-mart.hybrid-apigee.net"
        serviceAccountPath: ./service-accounts/{{org}}-mart-apigee.json
        sslCertPath: mart-server.pem
        sslKeyPath:  mart-server.key
      metrics:
        serviceAccountPath: ./service-accounts/{{org}}-metrics-apigee.json
      ingress:
        enableAccesslog: true
        runtime:
          loadBalancerIP: 35.196.24.106
        mart:
          loadBalancerIP: 35.185.43.207  
